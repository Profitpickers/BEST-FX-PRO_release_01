//+------------------------------------------------------------------+
//|                CurrencyStrengthAnalyzer.mqh                      |
//|           Modulo per calcolo forza valute da RELEASE_5          |
//|           Autore: Vito Iacobellis â€“ www.vitoiacobellis.it       |
//+------------------------------------------------------------------+

#ifndef __CURRENCY_STRENGTH_ANALYZER_MQH__
#define __CURRENCY_STRENGTH_ANALYZER_MQH__

#include "..\\include1\\MovingAverages.mqh" // Include corretto

// Enum per metodo MA esteso
enum ENUM_MA_METHOD_EXT
{
   MODE_SMA_EXT = MODE_SMA,  // Simple moving average
   MODE_EMA_EXT = MODE_EMA   // Exponential moving average
};

// Struttura per i parametri
struct CurrencyStrengthSettings
{
   int period;
   ENUM_MA_METHOD_EXT method;
};

// Classe analizzatore forza valute
class CCurrencyStrengthAnalyzer
{
private:
   string currencies[8];
   string pairs[28];
   CurrencyStrengthSettings settings;

public:
   void Init(const CurrencyStrengthSettings &cfg)
   {
      settings = cfg;
      InitArrays();
   }

   void InitArrays()
   {
      currencies[0] = "AUD"; currencies[1] = "CAD"; currencies[2] = "CHF"; currencies[3] = "EUR";
      currencies[4] = "GBP"; currencies[5] = "JPY"; currencies[6] = "NZD"; currencies[7] = "USD";

      string p[28] = {
         "AUDCAD", "AUDCHF", "AUDJPY", "AUDNZD", "AUDUSD", "CADCHF", "CADJPY", "CHFJPY",
         "EURAUD", "EURCAD", "EURCHF", "EURGBP", "EURJPY", "EURNZD", "EURUSD", "GBPAUD",
         "GBPCAD", "GBPCHF", "GBPJPY", "GBPUSD", "NZDCAD", "NZDJPY", "NZDUSD", "USDCAD",
         "USDCHF", "USDJPY"
      };
      ArrayCopy(pairs, p);
   }

   double GetCurrencyStrength(string currency, ENUM_TIMEFRAMES tf, int shift = 0)
   {
      double strength = 0;
      int count = 0;

      for (int i = 0; i < ArraySize(pairs); i++)
      {
         if (StringFind(pairs[i], currency) != -1)
         {
            double close = iClose(pairs[i], tf, shift);
            ENUM_MA_METHOD ma_method = (settings.method == MODE_SMA_EXT) ? MODE_SMA : MODE_EMA;

            int ma_handle = iMA(pairs[i], tf, settings.period, 0, ma_method, PRICE_CLOSE);
            double ma_buffer[];
            if (CopyBuffer(ma_handle, 0, shift, 1, ma_buffer) > 0)
            {
               double ma = ma_buffer[0];
               if (ma != 0)
               {
                  double ratio = (close - ma) / ma;
                  if (StringFind(pairs[i], currency) == 0)
                     strength += ratio;
                  else
                     strength -= ratio;
                  count++;
               }
            }
         }
      }

      return (count > 0) ? strength / count : 0;
   }

   string GetCurrency(int index)
   {
      return (index >= 0 && index < 8) ? currencies[index] : "";
   }
};

#endif // __CURRENCY_STRENGTH_ANALYZER_MQH__
